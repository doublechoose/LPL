<!DOCTYPE html>
<html>

<head>
  <title>tornado WebSocket example</title>
  <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>
  <div class="container">
    <h1>tornado WebSocket example</h1>
    <hr>
    WebSocket status : <span id="message"></span>
    <hr>
    <h3>The following string shows values by using WebSocket</h3>

    <span id="content">

    </span>

    <hr>
    <ul>
      <li>value 201 - 500 : change to yellow</li>
      <li>value 501 - : change to red</li>
    </ul>
  </div>
  <script>
    var url_path_join = function () {
      /**
       * join a sequence of url components with '/'
       */
      var url = '';
      for (var i = 0; i < arguments.length; i++) {
        if (arguments[i] === '') {
          continue;
        }
        if (url.length > 0 && url[url.length - 1] != '/') {
          url = url + '/' + arguments[i];
        } else {
          url = url + arguments[i];
        }
      }
      url = url.replace(/\/\/+/, '/');
      return url;
    };

    var uuid = function () {
      /**
       * http://www.ietf.org/rfc/rfc4122.txt
       */
      var s = [];
      var hexDigits = "0123456789abcdef";
      for (var i = 0; i < 32; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      s[12] = "4"; // bits 12-15 of the time_hi_and_version field to 0010
      s[16] = hexDigits.substr((s[16] & 0x3) | 0x8, 1); // bits 6-7 of the clock_seq_hi_and_reserved to 01

      var uuid = s.join("");
      return uuid;
    };
    var _deserialize_binary = function(data) {
        /**
         * deserialize the binary message format
         * callback will be called with a message whose buffers attribute
         * will be an array of DataViews.
         */
        if (data instanceof Blob) {
            // data is Blob, have to deserialize from ArrayBuffer in reader callback
            var reader = new FileReader();
            var promise = new Promise(function(resolve, reject) {
                reader.onload = function () {
                    var msg = _deserialize_array_buffer(this.result);
                    resolve(msg);
                };
            });
            reader.readAsArrayBuffer(data);
            return promise;
        } else {
            // data is ArrayBuffer, can deserialize directly
            var msg = _deserialize_array_buffer(data);
            return msg;
        }
    };

    var deserialize = function (data) {
        /**
         * deserialize a message and return a promise for the unpacked message
         */
        if (typeof data === "string") {
            // text JSON message
            return Promise.resolve(JSON.parse(data));
        } else {
            // binary message
            return Promise.resolve(_deserialize_binary(data));
        }
    };

    var _serialize_binary = function (msg) {
      /**
       * implement the binary serialization protocol
       * serializes JSON message to ArrayBuffer
       */
      msg = _.clone(msg);
      var offsets = [];
      var buffers = [];
      var i;
      for (i = 0; i < msg.buffers.length; i++) {
        // msg.buffers elements could be either views or ArrayBuffers
        // buffers elements are ArrayBuffers
        var b = msg.buffers[i];
        buffers.push(b.buffer instanceof ArrayBuffer ? b.buffer : b);
      }
      delete msg.buffers;
      var json_utf8 = (new TextEncoder('utf8')).encode(JSON.stringify(msg));
      buffers.unshift(json_utf8);
      var nbufs = buffers.length;
      offsets.push(4 * (nbufs + 1));
      for (i = 0; i + 1 < buffers.length; i++) {
        offsets.push(offsets[offsets.length - 1] + buffers[i].byteLength);
      }
      var msg_buf = new Uint8Array(
        offsets[offsets.length - 1] + buffers[buffers.length - 1].byteLength
      );
      // use DataView.setUint32 for network byte-order
      var view = new DataView(msg_buf.buffer);
      // write nbufs to first 4 bytes
      view.setUint32(0, nbufs);
      // write offsets to next 4 * nbufs bytes
      for (i = 0; i < offsets.length; i++) {
        view.setUint32(4 * (i + 1), offsets[i]);
      }
      // write all the buffers at their respective offsets
      for (i = 0; i < buffers.length; i++) {
        msg_buf.set(new Uint8Array(buffers[i]), offsets[i]);
      }

      // return raw ArrayBuffer
      return msg_buf.buffer;
    };

    var serialize = function (msg) {
      if (msg.buffers && msg.buffers.length) {
        return _serialize_binary(msg);
      } else {
        return JSON.stringify(msg);
      }
    };

    msg = {
      "header": {
        "msg_id": "39f9e4cbd29c48d08f5a501395e349e6",
        "username": "username",
        "session": "f86bd6af1c03453c8b55860e775a737e",
        "msg_type": "execute_request",
        "version": "5.2"
      },
      "metadata": {},
      "content": {
        "code": "print(\"pudong\")",
        "silent": false,
        "store_history": true,
        "user_expressions": {},
        "allow_stdin": true,
        "stop_on_error": true
      },
      "buffers": [],
      "parent_header": {},
      "channel": "shell"
    };
    ws_url = 'ws://localhost:8888';
    kernel_url = "/api/kernels/22916b55-bedd-4f19-b5e2-7f22e281527e";
    session_id = uuid();

    ws = new this.WebSocket([
      ws_url,
      url_path_join(kernel_url, 'channels'),
      "?session_id=" + session_id
    ].join(''));


    var $message = $('#message');

    ws.onopen = function () {
      $message.attr("class", 'label label-success');
      $message.text('open');
      
      ws.send(serialize(msg))
    };
    ws.onmessage = function (ev) {
      $message.attr("class", 'label label-info');
      $message.hide();
      $message.fadeIn("slow");
      $message.text('recieved message');
      
      var json = deserialize(ev.data);
      var $content = $('#content');
      $content.text(json);
    };
    ws.onclose = function (ev) {
      $message.attr("class", 'label label-important');
      $message.text('closed');
    };
    ws.onerror = function (ev) {
      $message.attr("class", 'label label-warning');
      $message.text('error occurred');
    };
  </script>
</body>

</html>